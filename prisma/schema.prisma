generator client_js {
  provider = "prisma-client-js"
  binaryTargets = ["native", "rhel-openssl-3.0.x"]
}

generator client {
  provider = "prisma-client"
  output   = "../lib/generated/prisma"
  binaryTargets = ["native", "rhel-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum MatchType {
  description_contains
  description_regex
  amount_equals
  always

  @@map("match_type")
}

model Firm {
  id        String        @id @default(dbgenerated("(md5(random()::text || clock_timestamp()::text))::uuid")) @db.Uuid
  name      String
  code      String
  createdAt DateTime      @default(now()) @map("created_at")
  updatedAt DateTime      @default(now()) @updatedAt @map("updated_at")
  vendors   Vendor[]
  glAccounts GlAccount[]
  dimensions Dimension[]
  vendorRules VendorRule[]
  runs       Run[]
  invoices   Invoice[]
  invoiceLines InvoiceLine[]
  memberships FirmMembership[]
  sessions  Session[]
  defaultUsers User[] @relation("DefaultFirm")
  files      File[]
  navPostLogs NavPostLog[]
  invoiceApprovals InvoiceApproval[]
  invitations InvitationToken[]
  mailboxes  Mailbox[]

  @@unique([code])
  @@map("firms")
}

model User {
  id             String            @id @default(dbgenerated("(md5(random()::text || clock_timestamp()::text))::uuid")) @db.Uuid
  email          String            @unique
  name           String?
  passwordHash   String            @map("password_hash")
  defaultFirmId  String?           @map("default_firm_id") @db.Uuid
  defaultFirm    Firm?             @relation("DefaultFirm", fields: [defaultFirmId], references: [id])
  memberships    FirmMembership[]
  sessions       Session[]
  passwordResetTokens PasswordResetToken[]
  invitationsSent   InvitationToken[] @relation("InvitationSent")
  invitationsAccepted InvitationToken[] @relation("InvitationAccepted")
  vendorCreated   Vendor[] @relation("VendorCreatedBy")
  vendorUpdated   Vendor[] @relation("VendorUpdatedBy")
  glAccountCreated GlAccount[] @relation("GlAccountCreatedBy")
  glAccountUpdated GlAccount[] @relation("GlAccountUpdatedBy")
  dimensionCreated Dimension[] @relation("DimensionCreatedBy")
  dimensionUpdated Dimension[] @relation("DimensionUpdatedBy")
  vendorRuleCreated VendorRule[] @relation("VendorRuleCreatedBy")
  vendorRuleUpdated VendorRule[] @relation("VendorRuleUpdatedBy")
  invoiceCreated Invoice[] @relation("InvoiceCreatedBy")
  invoiceUpdated Invoice[] @relation("InvoiceUpdatedBy")
  invoiceApprovals InvoiceApproval[]
  mailboxes       Mailbox[]
  createdAt      DateTime          @default(now()) @map("created_at")
  updatedAt      DateTime          @default(now()) @updatedAt @map("updated_at")

  @@map("users")
}

model Vendor {
  id                 String      @id @default(dbgenerated("(md5(random()::text || clock_timestamp()::text))::uuid")) @db.Uuid
  firmId             String      @map("firm_id") @db.Uuid
  firm               Firm        @relation(fields: [firmId], references: [id])
  vendorNo           String      @map("vendor_no")
  name               String
  gstNumber          String?     @map("gst_number")
  defaultDimensions  Json?       @map("default_dimensions")
  defaultCurrency    String?     @map("default_currency")
  active             Boolean     @default(true)
  createdBy          String?     @map("created_by") @db.Uuid
  updatedBy          String?     @map("updated_by") @db.Uuid
  createdByUser      User?       @relation("VendorCreatedBy", fields: [createdBy], references: [id])
  updatedByUser      User?       @relation("VendorUpdatedBy", fields: [updatedBy], references: [id])
  createdAt          DateTime    @default(now()) @map("created_at")
  updatedAt          DateTime    @default(now()) @updatedAt @map("updated_at")
  rules              VendorRule[]
  runs               Run[]
  invoices           Invoice[]

  @@unique([firmId, vendorNo])
  @@map("vendors")
}

model GlAccount {
  id        String   @id @default(dbgenerated("(md5(random()::text || clock_timestamp()::text))::uuid")) @db.Uuid
  firmId    String   @map("firm_id") @db.Uuid
  firm      Firm     @relation(fields: [firmId], references: [id])
  no        String   @map("no")
  name      String
  type      String?
  createdBy String?  @map("created_by") @db.Uuid
  updatedBy String?  @map("updated_by") @db.Uuid
  createdByUser User? @relation("GlAccountCreatedBy", fields: [createdBy], references: [id])
  updatedByUser User? @relation("GlAccountUpdatedBy", fields: [updatedBy], references: [id])
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at")

  @@unique([firmId, no])
  @@map("gl_accounts")
}

model Dimension {
  id        String   @id @default(dbgenerated("(md5(random()::text || clock_timestamp()::text))::uuid")) @db.Uuid
  firmId    String   @map("firm_id") @db.Uuid
  firm      Firm     @relation(fields: [firmId], references: [id])
  code      String
  valueCode String   @map("value_code")
  valueName String   @map("value_name")
  active    Boolean  @default(true)
  createdBy String?  @map("created_by") @db.Uuid
  updatedBy String?  @map("updated_by") @db.Uuid
  createdByUser User? @relation("DimensionCreatedBy", fields: [createdBy], references: [id])
  updatedByUser User? @relation("DimensionUpdatedBy", fields: [updatedBy], references: [id])
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at")

  @@unique([firmId, code, valueCode])
  @@map("dimensions")
}

model VendorRule {
  id                 String    @id @default(dbgenerated("(md5(random()::text || clock_timestamp()::text))::uuid")) @db.Uuid
  firmId             String    @map("firm_id") @db.Uuid
  firm               Firm      @relation(fields: [firmId], references: [id])
  vendorId           String    @map("vendor_id") @db.Uuid
  vendor             Vendor    @relation(fields: [vendorId], references: [id])
  priority           Int       @default(100)
  matchType          MatchType @map("match_type")
  matchValue         String?   @map("match_value")
  glAccountNo        String?   @map("gl_account_no")
  dimensionOverrides Json      @default(dbgenerated("'{}'::jsonb")) @map("dimension_overrides")
  active             Boolean   @default(true)
  comment            String?
  createdBy          String?   @map("created_by") @db.Uuid
  updatedBy          String?   @map("updated_by") @db.Uuid
  createdByUser      User?     @relation("VendorRuleCreatedBy", fields: [createdBy], references: [id])
  updatedByUser      User?     @relation("VendorRuleUpdatedBy", fields: [updatedBy], references: [id])
  createdAt          DateTime  @default(now()) @map("created_at")
  updatedAt          DateTime  @default(now()) @updatedAt @map("updated_at")

  @@index([vendorId, priority])
  @@index([firmId, priority])
  @@map("vendor_rules")
}

model Run {
  id               String   @id @default(dbgenerated("(md5(random()::text || clock_timestamp()::text))::uuid")) @db.Uuid
  firmId           String   @map("firm_id") @db.Uuid
  firm             Firm     @relation(fields: [firmId], references: [id])
  vendorId         String?  @map("vendor_id") @db.Uuid
  vendor           Vendor?  @relation(fields: [vendorId], references: [id])
  vendorNo         String?  @map("vendor_no")
  fileName         String?  @map("file_name")
  status           String   @default("processed")
  error            String?
  invoicePayload   Json?    @map("invoice_payload")
  ruleApplications Json?    @map("rule_applications")
  navPayload       Json?    @map("nav_payload")
  createdAt        DateTime @default(now()) @map("created_at")
  invoices         Invoice[]
  files            File[]
  navPostLogs      NavPostLog[]

  @@map("runs")
}

model Invoice {
  id              String        @id @default(dbgenerated("(md5(random()::text || clock_timestamp()::text))::uuid")) @db.Uuid
  firmId          String        @map("firm_id") @db.Uuid
  firm            Firm          @relation(fields: [firmId], references: [id])
  vendorId        String?       @map("vendor_id") @db.Uuid
  vendor          Vendor?       @relation(fields: [vendorId], references: [id])
  runId           String?       @map("run_id") @db.Uuid
  run             Run?          @relation(fields: [runId], references: [id])
  vendorNo        String?       @map("vendor_no")
  invoiceNo       String?       @map("invoice_no")
  invoiceDate     DateTime?     @map("invoice_date") @db.Date
  dueDate         DateTime?     @map("due_date") @db.Date
  currencyCode    String?       @map("currency_code")
  status          String        @default("draft")
  totalAmount     Decimal       @default(0) @map("total_amount") @db.Decimal(18, 2)
  taxAmount       Decimal       @default(0) @map("tax_amount") @db.Decimal(18, 2)
  netAmount       Decimal       @default(0) @map("net_amount") @db.Decimal(18, 2)
  originalPayload Json?         @map("original_payload")
  navDocumentNo   String?       @map("nav_document_no")
  navStatus       String?       @map("nav_status")
  lockedAt        DateTime?     @map("locked_at")
  postedAt        DateTime?     @map("posted_at")
  createdBy       String?       @map("created_by") @db.Uuid
  updatedBy       String?       @map("updated_by") @db.Uuid
  createdByUser   User?         @relation("InvoiceCreatedBy", fields: [createdBy], references: [id])
  updatedByUser   User?         @relation("InvoiceUpdatedBy", fields: [updatedBy], references: [id])
  createdAt       DateTime      @default(now()) @map("created_at")
  updatedAt       DateTime      @default(now()) @updatedAt @map("updated_at")
  lines           InvoiceLine[]
  files           File[]
  navPostLogs     NavPostLog[]
  approvals       InvoiceApproval[]

  @@unique([firmId, invoiceNo])
  @@map("invoices")
}

model InvoiceLine {
  id              String    @id @default(dbgenerated("(md5(random()::text || clock_timestamp()::text))::uuid")) @db.Uuid
  firmId          String    @map("firm_id") @db.Uuid
  firm            Firm      @relation(fields: [firmId], references: [id])
  invoiceId       String    @map("invoice_id") @db.Uuid
  invoice         Invoice   @relation(fields: [invoiceId], references: [id])
  lineNo          Int       @default(1) @map("line_no")
  description     String?
  quantity        Decimal   @default(1) @db.Decimal(18, 4)
  unitCost        Decimal   @default(0) @map("unit_cost") @db.Decimal(18, 4)
  lineAmount      Decimal   @default(0) @map("line_amount") @db.Decimal(18, 2)
  glAccountNo     String?   @map("gl_account_no")
  dimensionValues Json      @default(dbgenerated("'{}'::jsonb")) @map("dimension_values")
  taxCode         String?   @map("tax_code")
  taxRate         Decimal?  @map("tax_rate") @db.Decimal(10, 4)
  active          Boolean   @default(true)
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @default(now()) @updatedAt @map("updated_at")

  @@index([invoiceId])
  @@index([firmId, invoiceId, lineNo])
  @@map("invoice_lines")
}

model FirmMembership {
  id        String   @id @default(dbgenerated("(md5(random()::text || clock_timestamp()::text))::uuid")) @db.Uuid
  firmId    String   @map("firm_id") @db.Uuid
  firm      Firm     @relation(fields: [firmId], references: [id])
  userId    String   @map("user_id") @db.Uuid
  user      User     @relation(fields: [userId], references: [id])
  role      String   @default("member")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at")

  @@unique([firmId, userId])
  @@map("firm_memberships")
}

model Session {
  id        String   @id @default(dbgenerated("(md5(random()::text || clock_timestamp()::text))::uuid")) @db.Uuid
  firmId    String   @map("firm_id") @db.Uuid
  firm      Firm     @relation(fields: [firmId], references: [id])
  userId    String   @map("user_id") @db.Uuid
  user      User     @relation(fields: [userId], references: [id])
  token     String   @unique
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")

  @@map("sessions")
}

model PasswordResetToken {
  id        String   @id @default(dbgenerated("(md5(random()::text || clock_timestamp()::text))::uuid")) @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  user      User     @relation(fields: [userId], references: [id])
  token     String   @unique
  expiresAt DateTime @map("expires_at")
  usedAt    DateTime? @map("used_at")
  createdAt DateTime @default(now()) @map("created_at")

  @@map("password_reset_tokens")
}

model InvitationToken {
  id         String   @id @default(dbgenerated("(md5(random()::text || clock_timestamp()::text))::uuid")) @db.Uuid
  email      String
  firmId     String   @map("firm_id") @db.Uuid
  firm       Firm     @relation(fields: [firmId], references: [id])
  invitedBy  String?  @map("invited_by") @db.Uuid
  invitedByUser User? @relation("InvitationSent", fields: [invitedBy], references: [id])
  acceptedBy  String?  @map("accepted_by") @db.Uuid
  acceptedByUser User? @relation("InvitationAccepted", fields: [acceptedBy], references: [id])
  role       String   @default("member")
  token      String   @unique
  expiresAt  DateTime @map("expires_at")
  acceptedAt DateTime? @map("accepted_at")
  createdAt  DateTime @default(now()) @map("created_at")

  @@map("invitation_tokens")
}

model File {
  id          String   @id @default(dbgenerated("(md5(random()::text || clock_timestamp()::text))::uuid")) @db.Uuid
  firmId      String   @map("firm_id") @db.Uuid
  firm        Firm     @relation(fields: [firmId], references: [id])
  runId       String?  @map("run_id") @db.Uuid
  run         Run?     @relation(fields: [runId], references: [id])
  invoiceId   String?  @map("invoice_id") @db.Uuid
  invoice     Invoice? @relation(fields: [invoiceId], references: [id])
  fileName    String   @map("file_name")
  storagePath String   @map("storage_path")
  contentType String?  @map("content_type")
  sizeBytes   BigInt?  @map("size_bytes")
  checksum    String?
  createdAt   DateTime @default(now()) @map("created_at")

  @@index([firmId, runId, invoiceId])
  @@map("files")
}

model InvoiceApproval {
  id        String   @id @default(dbgenerated("(md5(random()::text || clock_timestamp()::text))::uuid")) @db.Uuid
  firmId    String   @map("firm_id") @db.Uuid
  firm      Firm     @relation(fields: [firmId], references: [id])
  invoiceId String   @map("invoice_id") @db.Uuid
  invoice   Invoice  @relation(fields: [invoiceId], references: [id])
  userId    String?  @map("user_id") @db.Uuid
  user      User?    @relation(fields: [userId], references: [id])
  status    String   @default("pending")
  comment   String?
  actedAt   DateTime? @map("acted_at")
  createdAt DateTime @default(now()) @map("created_at")

  @@index([invoiceId])
  @@index([firmId, invoiceId])
  @@map("invoice_approvals")
}

model NavPostLog {
  id        String   @id @default(dbgenerated("(md5(random()::text || clock_timestamp()::text))::uuid")) @db.Uuid
  firmId    String   @map("firm_id") @db.Uuid
  firm      Firm     @relation(fields: [firmId], references: [id])
  invoiceId String?  @map("invoice_id") @db.Uuid
  invoice   Invoice? @relation(fields: [invoiceId], references: [id])
  runId     String?  @map("run_id") @db.Uuid
  run       Run?     @relation(fields: [runId], references: [id])
  status    String
  message   String?
  response  Json?
  createdAt DateTime @default(now()) @map("created_at")

  @@index([firmId, invoiceId])
  @@map("nav_post_logs")
}

model Mailbox {
  id               String   @id @default(dbgenerated("(md5(random()::text || clock_timestamp()::text))::uuid")) @db.Uuid
  userId           String?  @map("user_id") @db.Uuid
  user             User?    @relation(fields: [userId], references: [id])
  firmId           String   @map("firm_id") @db.Uuid
  firm             Firm     @relation(fields: [firmId], references: [id])
  provider         String
  imapHost         String?  @map("imap_host")
  imapPort         Int?     @map("imap_port")
  imapTls          Boolean  @default(true) @map("imap_tls")
  imapUser         String?  @map("imap_user")
  encryptedSecret  String?  @map("encrypted_secret")
  allowedSenders   String?  @map("allowed_senders")
  subjectKeywords  String?  @map("subject_keywords")
  sourceMailbox    String?  @map("source_mailbox")
  processedMailbox String?  @map("processed_mailbox")
  lastSeenUid      BigInt?  @map("last_seen_uid")
  maxMessages      Int?     @default(10) @map("max_messages")
  active           Boolean  @default(true)
  lastRunAt        DateTime? @map("last_run_at")
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @default(now()) @updatedAt @map("updated_at")

  @@index([firmId])
  @@index([userId])
  @@map("mailboxes")
}
